<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonLens Connection Test</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; background: #2a2a2a; }
        .success { background: #004400; }
        .error { background: #440000; color: #ff4444; }
        button { background: #00aa00; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß CarbonLens Connection Test</h1>
    
    <div class="test">
        <h3>Server Connection Test</h3>
        <button onclick="testServerConnection()">Test Server Connection</button>
        <div id="serverResult"></div>
    </div>

    <div class="test">
        <h3>API Config Test</h3>
        <button onclick="testAPIConfig()">Test API Config</button>
        <div id="apiResult"></div>
    </div>

    <div class="test">
        <h3>JavaScript Libraries Test</h3>
        <button onclick="testLibraries()">Test Libraries</button>
        <div id="librariesResult"></div>
    </div>

    <div class="test">
        <h3>Full Diagnostic</h3>
        <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
        <div id="diagnosticResult"></div>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            div.className = isError ? 'error' : 'success';
            element.appendChild(div);
            console.log(message);
        }

        async function testServerConnection() {
            const resultDiv = document.getElementById('serverResult');
            resultDiv.innerHTML = '';
            
            try {
                log('serverResult', 'üîÑ Testing server connection...');
                
                const response = await fetch('/');
                log('serverResult', `‚úÖ Server responding: ${response.status} ${response.statusText}`);
                
                const html = await response.text();
                log('serverResult', `üìÑ Response length: ${html.length} characters`);
                
            } catch (error) {
                log('serverResult', `‚ùå Server connection failed: ${error.message}`, true);
            }
        }

        async function testAPIConfig() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '';
            
            try {
                log('apiResult', 'üîÑ Testing API config endpoint...');
                
                const response = await fetch('/api/config');
                log('apiResult', `üì° Response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                log('apiResult', `‚úÖ Config received successfully`);
                log('apiResult', `üîë Google Vision Key: ${config.googleVisionApiKey ? 'Present' : 'Missing'}`);
                log('apiResult', `üîë Gemini Key: ${config.geminiApiKey ? 'Present' : 'Missing'}`);
                
                resultDiv.innerHTML += `<pre>${JSON.stringify(config, null, 2)}</pre>`;
                
            } catch (error) {
                log('apiResult', `‚ùå API config test failed: ${error.message}`, true);
            }
        }

        function testLibraries() {
            const resultDiv = document.getElementById('librariesResult');
            resultDiv.innerHTML = '';
            
            log('librariesResult', 'üîÑ Testing JavaScript libraries...');
            
            // Test QuaggaJS
            if (typeof Quagga !== 'undefined') {
                log('librariesResult', '‚úÖ QuaggaJS: Loaded');
            } else {
                log('librariesResult', '‚ùå QuaggaJS: Missing', true);
            }
            
            // Test ProductDataAPI
            if (typeof ProductDataAPI !== 'undefined') {
                log('librariesResult', '‚úÖ ProductDataAPI: Loaded');
                try {
                    const api = new ProductDataAPI();
                    log('librariesResult', '‚úÖ ProductDataAPI: Can instantiate');
                } catch (e) {
                    log('librariesResult', `‚ùå ProductDataAPI: Cannot instantiate - ${e.message}`, true);
                }
            } else {
                log('librariesResult', '‚ùå ProductDataAPI: Missing', true);
            }
            
            // Test GeminiCarbonAnalyzer
            if (typeof GeminiCarbonAnalyzer !== 'undefined') {
                log('librariesResult', '‚úÖ GeminiCarbonAnalyzer: Loaded');
                try {
                    const analyzer = new GeminiCarbonAnalyzer('test-key');
                    log('librariesResult', '‚úÖ GeminiCarbonAnalyzer: Can instantiate');
                } catch (e) {
                    log('librariesResult', `‚ùå GeminiCarbonAnalyzer: Cannot instantiate - ${e.message}`, true);
                }
            } else {
                log('librariesResult', '‚ùå GeminiCarbonAnalyzer: Missing', true);
            }
        }

        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            resultDiv.innerHTML = '';
            
            log('diagnosticResult', 'üîÑ Running full diagnostic...');
            
            // Environment info
            log('diagnosticResult', `üåê URL: ${window.location.href}`);
            log('diagnosticResult', `üîí Protocol: ${window.location.protocol}`);
            log('diagnosticResult', `üè† Host: ${window.location.host}`);
            log('diagnosticResult', `üì± User Agent: ${navigator.userAgent}`);
            
            // Test all components
            await testServerConnection();
            await testAPIConfig();
            testLibraries();
            
            log('diagnosticResult', '‚úÖ Full diagnostic complete');
        }

        // Auto-run diagnostic on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Connection test page loaded');
        });
    </script>
</body>
</html>

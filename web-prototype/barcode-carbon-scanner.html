<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonLens - Barcode Carbon Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f5f5f5;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 20px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.8;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 25px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .shopping-list {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .shopping-list h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .item-card {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #333;
        }

        .item-barcode {
            font-size: 12px;
            color: #666;
        }

        .remove-item {
            padding: 5px 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-item-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .checkout-summary {
            margin: 20px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 12px;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .summary-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 1000;
            flex-direction: column;
        }

        .scanner-overlay.active {
            display: flex;
        }

        /* Ensure scanner controls are always visible */
        .scanner-overlay.active .scanner-controls {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .scanner-overlay.active .control-btn {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .scanner-header {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            text-align: center;
            color: white;
            position: relative;
            z-index: 1001;
        }

        .close-scanner {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            font-size: 20px;
            cursor: pointer;
        }

        .scanner-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .barcode-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scanning-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 150px;
            border: 3px solid #4CAF50;
            border-radius: 16px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { border-color: #4CAF50; box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { border-color: #8BC34A; box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { border-color: #4CAF50; box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .scanning-corners {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #4CAF50;
        }

        .corner-tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .corner-tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
        .corner-br { bottom: -2px; right: -2px; border-left: none; border-top: none; }

        .status-indicator {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-indicator.scanning {
            background: rgba(255, 193, 7, 0.9);
        }

        .status-indicator.detected {
            background: rgba(76, 175, 80, 0.9);
        }

        .barcode-result {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 12px;
            width: 200px;
            text-align: center;
            display: none;
        }

        .barcode-result.show {
            display: block;
        }

        .barcode-result h4 {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .barcode-result p {
            font-size: 12px;
            opacity: 0.9;
        }

        .scanner-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1003;
            backdrop-filter: blur(5px);
        }

        .control-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
            min-width: 160px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative;
            z-index: 1004;
        }

        .control-btn:hover {
            background: #45a049;
        }

        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .home-screen {
            padding: 20px;
        }

        .scan-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
        }

        .scan-button h3 {
            font-size: 20px;
            margin: 10px 0 5px 0;
        }

        .scan-button p {
            font-size: 14px;
            opacity: 0.8;
        }

        .barcode-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            z-index: 2000;
            overflow-y: auto;
        }

        .results-modal.active {
            display: block;
        }

        .results-content {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 20px;
            color: #333;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .close-results {
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            font-size: 20px;
            cursor: pointer;
        }

        .carbon-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .equivalents {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .equivalents h4 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .equivalents-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .equivalent-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .recommendations {
            background: #fff3cd;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .recommendations h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }

        .recommendations li {
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üå± CarbonLens</h1>
            <p>Barcode Carbon Scanner</p>
        </div>

        <!-- Home Screen -->
        <div class="home-screen">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="single" onclick="switchMode('single')">Single Item Mode</button>
                <button class="mode-btn" data-mode="shopping" onclick="switchMode('shopping')">Shopping Mode</button>
            </div>

            <div class="scan-button" onclick="startBarcodeScanner()">
                <div class="barcode-icon">üì±</div>
                <h3>Scan Product Barcode</h3>
                <p id="scanModeText">Point camera at barcode for instant carbon analysis</p>
            </div>

            <div id="shoppingList" class="shopping-list" style="display: none;">
                <h3>Shopping List</h3>
                <div id="itemList" class="item-list"></div>
                <button class="add-item-btn" onclick="addBarcodeEntry()">+ Add Item</button>
                <button id="checkoutBtn" class="checkout-btn" onclick="processCheckout()" disabled>Checkout</button>
            </div>


        <!-- Scanner Overlay -->
        <div class="scanner-overlay" id="scannerOverlay">
            <div class="scanner-header">
                <h3>üì± Barcode Scanner</h3>
                <button class="close-scanner" onclick="stopBarcodeScanner()">√ó</button>
            </div>
            
            <div class="scanner-container">
                <video id="scannerVideo" autoplay playsinline></video>
                
                <div class="barcode-overlay">
                    <div class="scanning-frame">
                        <div class="scanning-corners corner-tl"></div>
                        <div class="scanning-corners corner-tr"></div>
                        <div class="scanning-corners corner-bl"></div>
                        <div class="scanning-corners corner-br"></div>
                    </div>
                    
                    <div class="status-indicator" id="statusIndicator">Point at barcode</div>
                    
                    <div class="barcode-result" id="barcodeResult">
                        <h4>Barcode Detected!</h4>
                        <p id="barcodeNumber">1234567890</p>
                    </div>
                </div>

                <div class="scanner-controls">
                    <button class="control-btn" onclick="manualBarcodeInput()" id="manualBtn">Manual Input</button>
                    <button class="control-btn" onclick="switchCamera()">Switch Camera</button>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div class="results-modal" id="resultsModal">
            <div class="results-content">
                <div class="results-header">
                    <h2>üå± Carbon Analysis Results</h2>
                    <button class="close-results" onclick="closeResults()">√ó</button>
                </div>
                
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" 
            onerror="console.error('‚ùå Failed to load QuaggaJS library')"></script>
    <script src="product-api.js" 
            onerror="console.error('‚ùå Failed to load product-api.js')"></script>
    <script src="gemini-carbon-analyzer.js" 
            onerror="console.error('‚ùå Failed to load gemini-carbon-analyzer.js')"></script>
    
    <script>
        // Global variables
        let currentStream = null;
        let usingFrontCamera = false;
        let quaggaInitialized = false;
        let productAPI = null;
        let geminiAnalyzer = null;
        let googleVisionApiKey = '';
        let geminiApiKey = '';
        let apisInitialized = false;
        let currentMode = 'single';
        let shoppingList = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üß† DOMContentLoaded fired');
            console.log('üîç Running comprehensive startup diagnostic...');
            
            // Check if required libraries are loaded
            console.log('üìö Library check:');
            console.log('  - Quagga:', typeof Quagga !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
            console.log('  - ProductDataAPI:', typeof ProductDataAPI !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
            console.log('  - GeminiCarbonAnalyzer:', typeof GeminiCarbonAnalyzer !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
            
            // Check network connectivity
            console.log('üåê Network check:');
            console.log('  - Current URL:', window.location.href);
            console.log('  - Protocol:', window.location.protocol);
            console.log('  - Host:', window.location.host);
            
            // Load API keys
            await loadApiKeys();
            
            // Initialize APIs
            initializeAPIs();
            
            // Final diagnostic
            logDiagnosticState('DOMContentLoaded complete');
            
            console.log('üéØ Startup diagnostic complete');
        });

        async function loadApiKeys() {
            try {
                console.log('üîÑ Attempting to load API keys from /api/config...');
                const response = await fetch('/api/config');
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                console.log('üìã Config received:', config);
                
                googleVisionApiKey = config.googleVisionApiKey;
                geminiApiKey = config.geminiApiKey || 'YOUR_GEMINI_API_KEY';
                
                console.log('‚úÖ API keys loaded successfully');
                console.log('üîë Google Vision Key present:', !!googleVisionApiKey);
                console.log('üîë Gemini Key present:', !!geminiApiKey && geminiApiKey !== 'YOUR_GEMINI_API_KEY');
                
            } catch (error) {
                console.error('‚ùå Failed to load API keys:', error);
                console.error('üîç Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Show user-friendly error
                alert(`Failed to connect to server!\n\nError: ${error.message}\n\nPlease check:\n1. Server is running on port 3001\n2. You're accessing via HTTPS\n3. Certificate is accepted`);
            }
        }

        function initializeAPIs() {
            try {
                console.log('üîÑ Initializing APIs...');
                
                // Check if we have the required keys
                if (!googleVisionApiKey) {
                    console.warn('‚ö†Ô∏è Google Vision API key missing');
                }
                
                if (!geminiApiKey || geminiApiKey === 'YOUR_GEMINI_API_KEY') {
                    console.warn('‚ö†Ô∏è Gemini API key missing or placeholder');
                }
                
                // Initialize APIs
                productAPI = new ProductDataAPI();
                console.log('‚úÖ ProductDataAPI initialized');
                
                geminiAnalyzer = new GeminiCarbonAnalyzer(geminiApiKey);
                console.log('‚úÖ GeminiCarbonAnalyzer initialized');
                
                apisInitialized = true;
                logDiagnosticState('initializeAPIs success');
                console.log('‚úÖ All APIs initialized successfully');
                
            } catch (error) {
                apisInitialized = false;
                console.error('‚ùå API initialization failed:', error);
                console.error('üîç Initialization error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                logDiagnosticState('initializeAPIs failure', error);
                
                // Show user-friendly error
                alert(`API Initialization Failed!\n\nError: ${error.message}\n\nThis might be due to:\n1. Missing API keys\n2. JavaScript library loading issues\n3. Network connectivity problems`);
            }
        }

        function logDiagnosticState(context = 'diagnostic', extraError = null) {
            const state = {
                context,
                timestamp: new Date().toISOString(),
                apisInitialized,
                productAPI: !!productAPI,
                geminiAnalyzer: !!geminiAnalyzer,
                googleVisionApiKeyPresent: !!googleVisionApiKey,
                geminiApiKeyPresent: !!geminiApiKey && geminiApiKey !== 'YOUR_GEMINI_API_KEY',
                geminiApiKeyValue: geminiApiKey,
            };
            console.table(state);
            if (extraError) {
                console.error('Diagnostic error details:', extraError);
            }
        }

        async function startBarcodeScanner() {
            const overlay = document.getElementById('scannerOverlay');
            const manualBtn = document.getElementById('manualBtn');
            
            console.log('üöÄ Starting barcode scanner...');
            console.log('Manual button element:', manualBtn);
            
            overlay.classList.add('active');
            
            logDiagnosticState('startBarcodeScanner before init check');
            if (!apisInitialized) {
                console.warn('‚ö†Ô∏è APIs not initialized yet. Attempting to initialize again.');
                initializeAPIs();
                logDiagnosticState('startBarcodeScanner after forced init');
            }

            // Ensure manual button is visible and functional with a slight delay
            setTimeout(() => {
                const manualBtnCheck = document.getElementById('manualBtn');
                const switchBtn = document.querySelector('button[onclick="switchCamera()"]');
                
                if (manualBtnCheck) {
                    manualBtnCheck.style.display = 'block';
                    manualBtnCheck.style.visibility = 'visible';
                    manualBtnCheck.style.opacity = '1';
                    manualBtnCheck.style.pointerEvents = 'auto';
                    console.log('‚úÖ Manual button made visible (delayed check)');
                }
                
                if (switchBtn) {
                    switchBtn.style.display = 'block';
                    switchBtn.style.visibility = 'visible';
                    switchBtn.style.opacity = '1';
                    switchBtn.style.pointerEvents = 'auto';
                    console.log('‚úÖ Switch camera button made visible');
                }
            }, 100);
            
            try {
                await startCamera();
                initializeQuagga();
                updateStatus('Point camera at barcode', 'scanning');
                console.log('‚úÖ Scanner initialized successfully');
            } catch (error) {
                console.error('‚ùå Scanner failed:', error);
                updateStatus('Scanner Error', 'error');
                
                // Make sure manual input is still available if camera fails
                if (manualBtn) {
                    manualBtn.style.display = 'block';
                    manualBtn.style.visibility = 'visible';
                    manualBtn.style.opacity = '1';
                }
            }
        }

        function stopBarcodeScanner() {
            const overlay = document.getElementById('scannerOverlay');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (quaggaInitialized) {
                Quagga.stop();
                quaggaInitialized = false;
            }
            
            overlay.classList.remove('active');
            hideBarcodeResult();
        }

        async function startCamera() {
            const video = document.getElementById('scannerVideo');
            
            const constraints = {
                video: {
                    facingMode: usingFrontCamera ? 'user' : 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            console.log('‚úÖ Camera started for barcode scanning');
        }

        function initializeQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scannerVideo'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: usingFrontCamera ? 'user' : 'environment'
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error('‚ùå Quagga initialization failed:', err);
                    return;
                }
                
                console.log('‚úÖ QuaggaJS initialized for barcode detection');
                quaggaInitialized = true;
                Quagga.start();
            });

            // Handle barcode detection with validation
            let lastDetectedBarcode = null;
            let detectionCount = 0;
            let detectionConfidence = 0;
            
            Quagga.onDetected(function(result) {
                const barcode = result.codeResult.code;
                const confidence = result.codeResult.confidence || 0;
                
                // Validate barcode format and confidence
                if (!isValidBarcode(barcode) || confidence < 60) {
                    console.log('‚ö†Ô∏è Invalid barcode or low confidence:', barcode, 'confidence:', confidence);
                    return;
                }
                
                // Require multiple consistent detections
                if (barcode === lastDetectedBarcode) {
                    detectionCount++;
                    detectionConfidence = Math.max(detectionConfidence, confidence);
                } else {
                    lastDetectedBarcode = barcode;
                    detectionCount = 1;
                    detectionConfidence = confidence;
                }
                
                // Only proceed if we have 3+ consistent detections with good confidence
                if (detectionCount >= 3 && detectionConfidence > 70) {
                    console.log('‚úÖ Barcode validated:', barcode, 'confidence:', detectionConfidence);
                    
                    showBarcodeResult(barcode);
                    updateStatus('Barcode validated!', 'detected');
                    
                    // Reset detection tracking
                    lastDetectedBarcode = null;
                    detectionCount = 0;
                    detectionConfidence = 0;
                    
                    setTimeout(() => {
                        processBarcode(barcode);
                    }, 1500);
                } else {
                    updateStatus(`Validating... (${detectionCount}/3)`, 'scanning');
                }
            });
        }

        function showBarcodeResult(barcode) {
            document.getElementById('barcodeNumber').textContent = barcode;
            document.getElementById('barcodeResult').classList.add('show');
        }

        function hideBarcodeResult() {
            document.getElementById('barcodeResult').classList.remove('show');
        }

        function updateStatus(text, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = text;
            indicator.className = `status-indicator ${type}`;
        }

        // Validate barcode format and checksum
        function isValidBarcode(barcode) {
            if (!barcode || typeof barcode !== 'string') return false;
            
            // Remove any non-digit characters
            const digits = barcode.replace(/\D/g, '');
            
            console.log('üîç Validating barcode:', {
                original: barcode,
                cleaned: digits,
                length: digits.length
            });
            
            // Check common barcode lengths
            const validLengths = [8, 12, 13, 14]; // EAN-8, UPC-A, EAN-13, ITF-14
            if (!validLengths.includes(digits.length)) {
                console.log('‚ö†Ô∏è Invalid barcode length:', digits.length, 'Expected:', validLengths);
                return false;
            }
            
            // Basic format validation
            if (digits.length < 8 || digits.length > 14) {
                console.log('‚ö†Ô∏è Barcode length out of range:', digits.length);
                return false;
            }
            
            // Check for obviously invalid patterns (but be less strict)
            if (/^0{8,}$/.test(digits)) {
                console.log('‚ö†Ô∏è Invalid barcode pattern (all zeros):', digits);
                return false;
            }
            
            // For testing purposes, allow some patterns that might be test barcodes
            if (digits.length === 12 || digits.length === 13) {
                // Try checksum validation, but don't fail if it's a test barcode
                const checksumValid = validateEANChecksum(digits);
                if (!checksumValid) {
                    console.log('‚ö†Ô∏è Checksum failed, but allowing for testing purposes');
                    // Allow it anyway for testing - real products will have valid checksums
                    return true;
                }
                return true;
            }
            
            // For other lengths, just check basic format
            return true;
        }

        // Validate EAN/UPC checksum
        function validateEANChecksum(barcode) {
            const digits = barcode.split('').map(Number);
            const checkDigit = digits.pop();
            const length = barcode.length;
            
            let sum = 0;
            
            if (length === 12) {
                // UPC-A: multiply odd positions by 3, even positions by 1 (from right)
                for (let i = 0; i < digits.length; i++) {
                    sum += digits[i] * ((i % 2 === 0) ? 3 : 1);
                }
            } else if (length === 13) {
                // EAN-13: multiply odd positions by 1, even positions by 3 (from left)
                for (let i = 0; i < digits.length; i++) {
                    sum += digits[i] * ((i % 2 === 0) ? 1 : 3);
                }
            } else {
                console.log('‚ö†Ô∏è Unsupported barcode length for checksum:', length);
                return false;
            }
            
            const calculatedCheck = (10 - (sum % 10)) % 10;
            const isValid = calculatedCheck === checkDigit;
            
            console.log(`üîç Checksum validation for ${length}-digit barcode:`, {
                barcode: barcode,
                digits: digits,
                sum: sum,
                expectedCheck: calculatedCheck,
                actualCheck: checkDigit,
                isValid: isValid
            });
            
            return isValid;
        }

        async function processBarcode(barcode) {
            updateStatus('Processing barcode...', 'scanning');

            if (currentMode === 'shopping') {
                try {
                    const productData = await productAPI.getProductData(barcode);
                    await addToShoppingList(barcode, productData);
                    stopBarcodeScanner();
                    return;
                } catch (error) {
                    console.error('Failed to add item:', error);
                    alert('Failed to add item to shopping list. Please try again.');
                    return;
                }
            }

            
            try {
                // Step 1: Validate APIs are initialized
                logDiagnosticState('processBarcode start');
                if (!apisInitialized || !productAPI || !geminiAnalyzer) {
                    logDiagnosticState('processBarcode apis not ready');
                    throw new Error('APIs not initialized. Please refresh the page.');
                }
                
                // Step 2: Fetch product data
                console.log('üîç Fetching product data for:', barcode);
                updateStatus('Fetching product data...', 'scanning');
                const productData = await productAPI.getProductData(barcode);
                console.log('‚úÖ Product data:', productData);
                
                if (productData.error) {
                    throw new Error(`Product lookup failed: ${productData.error}`);
                }
                
                // Step 3: Analyze with Gemini
                console.log('ü§ñ Analyzing with Gemini AI...');
                updateStatus('Analyzing carbon footprint...', 'scanning');
                const carbonAnalysis = await geminiAnalyzer.analyzeCarbonFootprint(productData);
                console.log('‚úÖ Carbon analysis:', carbonAnalysis);
                
                // Step 4: Display results
                displayCarbonResults(productData, carbonAnalysis);
                
            } catch (error) {
                console.error('‚ùå Barcode processing failed:', error);
            logDiagnosticState('processBarcode catch', error);
                updateStatus('Processing failed', 'error');
                
                // Show detailed error message
                let errorMessage = 'Failed to process barcode.\n\n';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'API Key Issue:\n‚Ä¢ Check your Gemini API key in .env file\n‚Ä¢ Ensure the key is valid and active';
                } else if (error.message.includes('Product not found')) {
                    errorMessage += 'Product Not Found:\n‚Ä¢ This barcode might not be in the database\n‚Ä¢ Try a different product or manual input';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network Issue:\n‚Ä¢ Check your internet connection\n‚Ä¢ Try again in a moment';
                } else {
                    errorMessage += `Error: ${error.message}\n\nPlease try again or contact support.`;
                }
                
                alert(errorMessage);
            }
        }

        function displayCarbonResults(productData, analysis) {
            const modal = document.getElementById('resultsModal');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>${productData.name}</h3>
                    <p style="color: #666; font-size: 14px;">${productData.brand} ‚Ä¢ ${productData.category}</p>
                </div>
                
                <div class="carbon-metrics">
                    <div class="metric-card">
                        <div class="metric-value">${analysis.carbonFootprint.perUnit.toFixed(2)}</div>
                        <div class="metric-label">kg CO‚ÇÇ per unit</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.carbonFootprint.per1000Units.toFixed(0)}</div>
                        <div class="metric-label">kg CO‚ÇÇ per 1000 units</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.waterUsage.perUnit}</div>
                        <div class="metric-label">liters per unit</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.sustainabilityScore}</div>
                        <div class="metric-label">sustainability score</div>
                    </div>
                </div>
                
                <div class="equivalents">
                    <h4>üåç Environmental Equivalents</h4>
                    <div class="equivalents-list">
                        <div class="equivalent-item">
                            <div style="font-weight: bold; color: #4CAF50;">${analysis.environmentalEquivalents.treesAbsorbed}</div>
                            <div style="font-size: 12px;">trees absorbed</div>
                        </div>
                        <div class="equivalent-item">
                            <div style="font-weight: bold; color: #4CAF50;">${analysis.environmentalEquivalents.milesDriven}</div>
                            <div style="font-size: 12px;">miles driven</div>
                        </div>
                        <div class="equivalent-item">
                            <div style="font-weight: bold; color: #4CAF50;">${analysis.environmentalEquivalents.showersEquivalent}</div>
                            <div style="font-size: 12px;">showers equivalent</div>
                        </div>
                        <div class="equivalent-item">
                            <div style="font-weight: bold; color: #4CAF50;">${analysis.environmentalEquivalents.plasticBottlesEquivalent}</div>
                            <div style="font-size: 12px;">plastic bottles</div>
                        </div>
                    </div>
                </div>
                
                <div class="recommendations">
                    <h4>üí° Recommendations</h4>
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 20px;">
                    <h4 style="color: #4CAF50; margin-bottom: 10px;">üìä Analysis Summary</h4>
                    <p style="font-size: 14px; line-height: 1.5;">
                        <strong>Key Findings:</strong> ${analysis.analysis.keyFindings}<br>
                        <strong>Strengths:</strong> ${analysis.analysis.strengths}<br>
                        <strong>Concerns:</strong> ${analysis.analysis.concerns}
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
            stopBarcodeScanner();
        }

        function closeResults() {
            document.getElementById('resultsModal').classList.remove('active');
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const shoppingList = document.getElementById('shoppingList');
            const scanModeText = document.getElementById('scanModeText');

            if (mode === 'shopping') {
                shoppingList.style.display = 'block';
                scanModeText.textContent = 'Scan items to add to your shopping list';
            } else {
                shoppingList.style.display = 'none';
                scanModeText.textContent = 'Point camera at barcode for instant carbon analysis';
            }
        }

        function addBarcodeEntry() {
            const barcode = prompt('Enter barcode number (8-14 digits):');
            if (barcode && isValidBarcode(barcode)) {
                processBarcode(barcode);
            } else if (barcode) {
                alert('Invalid barcode format! Please enter a valid barcode.');
            }
        }

        async function addToShoppingList(barcode, productData) {
            try {
                // Get carbon analysis immediately when adding to cart
                const analysis = await geminiAnalyzer.analyzeCarbonFootprint(productData);
                
                const item = {
                    barcode,
                    name: productData.name || 'Unknown Product',
                    brand: productData.brand || 'Unknown Brand',
                    data: productData,
                    analysis,
                    carbonFootprint: analysis.carbonFootprint.perUnit
                };

                shoppingList.push(item);
                updateShoppingListUI();
            } catch (error) {
                console.error('Failed to analyze item:', error);
                alert('Failed to add item to cart. Please try again.');
            }
        }

        function removeFromShoppingList(index) {
            shoppingList.splice(index, 1);
            updateShoppingListUI();
        }

        function updateShoppingListUI() {
            const itemList = document.getElementById('itemList');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            itemList.innerHTML = '';
            shoppingList.forEach((item, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-barcode">${item.barcode}</div>
                    </div>
                    <button class="remove-item" onclick="removeFromShoppingList(${index})">√ó</button>
                `;
                itemList.appendChild(itemCard);
            });

            checkoutBtn.disabled = shoppingList.length === 0;
        }

        async function processCheckout() {
            if (shoppingList.length === 0) return;

            updateStatus('Processing checkout...', 'scanning');
            
            try {
                let totalCarbonFootprint = 0;
                let totalWaterUsage = 0;
                let totalTrees = 0;
                let totalMiles = 0;
                
                // Items already have analysis data, just calculate totals
                shoppingList.forEach(item => {
                    totalCarbonFootprint += item.carbonFootprint;
                    totalWaterUsage += item.analysis.waterUsage.perUnit;
                    totalTrees += item.analysis.environmentalEquivalents.treesAbsorbed;
                    totalMiles += item.analysis.environmentalEquivalents.milesDriven;
                });

                // Sort items by CO2 footprint
                const sortedItems = [...shoppingList].sort((a, b) => b.carbonFootprint - a.carbonFootprint);

                // Display checkout summary
                displayCheckoutSummary({
                    items: shoppingList.length,
                    totalCarbonFootprint,
                    totalWaterUsage,
                    totalTrees,
                    totalMiles,
                    sortedItems,
                    recommendations: sortedItems[0]?.analysis.recommendations || []
                });

                // Clear shopping list after successful checkout
                shoppingList = [];
                updateShoppingListUI();

            } catch (error) {
                console.error('Checkout failed:', error);
                alert('Failed to process checkout. Please try again.');
            }
        }

        function displayCheckoutSummary(summary) {
            const content = document.getElementById('resultsContent');
            const worstItem = summary.sortedItems[0];
            
            content.innerHTML = `
                <div class="checkout-summary">
                    <div class="summary-header">
                        <h3>üõí Shopping List Summary</h3>
                        <div>Total Items: ${summary.items}</div>
                    </div>
                    
                    <div class="summary-metrics">
                        <div class="summary-metric">
                            <div class="metric-title">Total CO‚ÇÇ Footprint</div>
                            <div class="metric-value">${(summary.totalCarbonFootprint).toFixed(2)} kg</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-title">Total Water Usage</div>
                            <div class="metric-value">${Math.round(summary.totalWaterUsage)} L</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-title">Trees Required (per 1000)</div>
                            <div class="metric-value">${(summary.totalTrees * 1000).toFixed(1)}</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-title">Miles Driven (per 1000)</div>
                            <div class="metric-value">${(summary.totalMiles * 1000).toFixed(1)}</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üßæ CO‚ÇÇ Receipt</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 10px; color: #666;">Item</th>
                                    <th style="text-align: right; padding: 10px; color: #666;">CO‚ÇÇ/Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summary.sortedItems.map(item => `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 12px;">${item.name}</td>
                                        <td style="text-align: right; padding: 12px; color: ${
                                            item.carbonFootprint > 5 ? '#ff4444' : 
                                            item.carbonFootprint > 2 ? '#ffa726' : '#4CAF50'
                                        }; font-weight: bold;">
                                            ${item.carbonFootprint.toFixed(2)} kg
                                        </td>
                                    </tr>
                                `).join('')}
                                <tr style="border-top: 2px solid #e0e0e0; background: #f8f9fa;">
                                    <td style="padding: 12px; font-weight: bold;">Total</td>
                                    <td style="text-align: right; padding: 12px; font-weight: bold;">
                                        ${summary.totalCarbonFootprint.toFixed(2)} kg
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    ${worstItem ? `
                        <div style="margin: 20px 0; background: #fff3e0; padding: 20px; border-radius: 12px;">
                            <h4 style="color: #ff9800; margin-bottom: 15px;">üí° How to Lower Your CO‚ÇÇ Bill</h4>
                            <div style="margin-bottom: 15px;">
                                <p style="margin-bottom: 10px;">Your highest impact item is <strong>${worstItem.name}</strong> at ${worstItem.carbonFootprint.toFixed(2)} kg CO‚ÇÇ per unit.</p>
                                <p style="margin-bottom: 10px;">Consider these eco-friendly alternatives:</p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${worstItem.analysis.recommendations.map(rec => `
                                        <li style="margin: 5px 0; color: #666;">${rec}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}

                    <div class="recommendations" style="background: #e8f5e9;">
                        <h4>üå± Eco Tips</h4>
                        <ul>
                            <li>Look for products with green certifications</li>
                            <li>Choose local products when possible to reduce transport emissions</li>
                            <li>Consider bulk buying to reduce packaging waste</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Show the modal
            document.getElementById('resultsModal').classList.add('active');
            
            document.getElementById('resultsModal').classList.add('active');
        }

        function manualBarcodeInput() {
            const barcode = prompt('Enter barcode number (8-14 digits):');
            if (barcode) {
                const cleanBarcode = barcode.replace(/\D/g, ''); // Remove non-digits
                
                if (!isValidBarcode(cleanBarcode)) {
                    alert(`Invalid barcode format!\n\nPlease enter a valid barcode:\n‚Ä¢ 8 digits (EAN-8)\n‚Ä¢ 12 digits (UPC-A)\n‚Ä¢ 13 digits (EAN-13)\n‚Ä¢ 14 digits (ITF-14)\n\nExample: 3017620422003`);
                    return;
                }
                
                console.log('‚úÖ Manual barcode input validated:', cleanBarcode);
                showBarcodeResult(cleanBarcode);
                updateStatus('Manual barcode validated!', 'detected');
                
                setTimeout(() => {
                    processBarcode(cleanBarcode);
                }, 1000);
            }
        }

        async function switchCamera() {
            if (!currentStream) return;
            
            currentStream.getTracks().forEach(track => track.stop());
            usingFrontCamera = !usingFrontCamera;
            await startCamera();
            
            if (quaggaInitialized) {
                Quagga.stop();
                quaggaInitialized = false;
            }
            initializeQuagga();
        }

        // Test API configuration
        async function testAPIConfiguration() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                console.log('üîß API Configuration Test:');
                console.log('‚Ä¢ Google Vision API Key:', config.googleVisionApiKey ? '‚úÖ Present' : '‚ùå Missing');
                console.log('‚Ä¢ Gemini API Key:', config.geminiApiKey ? '‚úÖ Present' : '‚ùå Missing');
                
                if (!config.geminiApiKey || config.geminiApiKey === 'YOUR_GEMINI_API_KEY_HERE') {
                    console.error('‚ùå Gemini API key not configured!');
                    alert('Setup Required:\n\n1. Get your Gemini API key from https://aistudio.google.com/\n2. Add it to your .env file as GEMINI_API_KEY\n3. Restart the server');
                }
                
                return config;
            } catch (error) {
                console.error('‚ùå API configuration test failed:', error);
                return null;
            }
        }

        // Test with a known good barcode
        function testWithSampleBarcode() {
            const sampleBarcode = '3017620422003'; // Nutella - known to be in Open Food Facts
            console.log('üß™ Testing with sample barcode:', sampleBarcode);
            processBarcode(sampleBarcode);
        }

        // Add test button to home screen
        document.addEventListener('DOMContentLoaded', function() {
            testAPIConfiguration();
            
            // Add test button
            const homeScreen = document.querySelector('.home-screen');
            const testButton = document.createElement('div');
            testButton.style.cssText = 'margin: 10px 20px; padding: 10px; background: #007bff; color: white; border-radius: 8px; text-align: center; cursor: pointer; font-size: 14px;';
            testButton.textContent = 'üß™ Test with Sample Barcode (Nutella)';
            testButton.onclick = testWithSampleBarcode;
            homeScreen.appendChild(testButton);
        });

        // Check camera support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.warn('‚ö†Ô∏è Camera API not supported');
        } else {
            console.log('‚úÖ Camera API supported for barcode scanning');
        }
    </script>
</body>
</html>

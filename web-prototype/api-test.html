<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonLens API Test Suite</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #004400; color: #00ff00; }
        .error { background: #440000; color: #ff4444; }
        .warning { background: #444400; color: #ffff00; }
        .info { background: #000044; color: #4444ff; }
        button {
            background: #00aa00;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #00cc00; }
        .loading { color: #ffaa00; }
        pre { 
            background: #111; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üß™ CarbonLens API Test Suite</h1>
    
    <div class="test-section">
        <h2>üìã Test Controls</h2>
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="testAPIConfig()">üîë Test API Config</button>
        <button onclick="testBarcodeValidation()">üì± Test Barcode Validation</button>
        <button onclick="testProductAPI()">üçé Test Product API</button>
        <button onclick="testGeminiAPI()">ü§ñ Test Gemini API</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div id="results"></div>

    <script src="product-api.js"></script>
    <script src="gemini-carbon-analyzer.js"></script>
    
    <script>
        let productAPI = null;
        let geminiAnalyzer = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Starting comprehensive API test suite...', 'info');
            
            await testAPIConfig();
            await testBarcodeValidation();
            await testProductAPI();
            await testGeminiAPI();
            
            log('‚úÖ All tests completed!', 'success');
        }

        async function testAPIConfig() {
            log('üîë Testing API Configuration...', 'info');
            
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response data: <pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
                
                // Test Google Vision API Key
                if (config.googleVisionApiKey) {
                    if (config.googleVisionApiKey.startsWith('AIza')) {
                        log('‚úÖ Google Vision API Key: Valid format', 'success');
                    } else {
                        log('‚ö†Ô∏è Google Vision API Key: Invalid format', 'warning');
                    }
                } else {
                    log('‚ùå Google Vision API Key: Missing', 'error');
                }
                
                // Test Gemini API Key
                if (config.geminiApiKey) {
                    if (config.geminiApiKey === 'YOUR_GEMINI_API_KEY_HERE' || config.geminiApiKey === 'your_gemini_api_key_here') {
                        log('‚ùå Gemini API Key: Not configured (placeholder value)', 'error');
                    } else if (config.geminiApiKey.startsWith('AIza')) {
                        log('‚úÖ Gemini API Key: Valid format', 'success');
                    } else {
                        log('‚ö†Ô∏è Gemini API Key: Unusual format (might be valid)', 'warning');
                    }
                } else {
                    log('‚ùå Gemini API Key: Missing', 'error');
                }
                
                // Initialize APIs
                productAPI = new ProductDataAPI();
                geminiAnalyzer = new GeminiCarbonAnalyzer(config.geminiApiKey);
                log('‚úÖ APIs initialized successfully', 'success');
                
            } catch (error) {
                log(`‚ùå API Config test failed: ${error.message}`, 'error');
            }
        }

        async function testBarcodeValidation() {
            log('üì± Testing Barcode Validation...', 'info');
            
            const testBarcodes = [
                { code: '123456789012', name: '12-digit UPC-A', shouldPass: true },
                { code: '1234567890123', name: '13-digit EAN-13', shouldPass: true },
                { code: '3017620422003', name: 'Nutella (known good)', shouldPass: true },
                { code: '012345678905', name: 'UPC-A with valid checksum', shouldPass: true },
                { code: '1234567890', name: '10-digit (invalid length)', shouldPass: false },
                { code: '000000000000', name: 'All zeros', shouldPass: false },
                { code: 'abc123def456', name: 'Contains letters', shouldPass: false },
                { code: '', name: 'Empty string', shouldPass: false }
            ];
            
            // Test the validation function from the main app
            function testIsValidBarcode(barcode) {
                if (!barcode || typeof barcode !== 'string') return false;
                
                const digits = barcode.replace(/\D/g, '');
                const validLengths = [8, 12, 13, 14];
                
                if (!validLengths.includes(digits.length)) return false;
                if (digits.length < 8 || digits.length > 14) return false;
                if (/^0{8,}$/.test(digits)) return false;
                
                return true; // Simplified for testing
            }
            
            testBarcodes.forEach(test => {
                const result = testIsValidBarcode(test.code);
                const passed = result === test.shouldPass;
                
                log(`${passed ? '‚úÖ' : '‚ùå'} ${test.name}: "${test.code}" -> ${result} (expected: ${test.shouldPass})`, 
                    passed ? 'success' : 'error');
            });
        }

        async function testProductAPI() {
            log('üçé Testing Product API (Open Food Facts)...', 'info');
            
            if (!productAPI) {
                log('‚ùå Product API not initialized', 'error');
                return;
            }
            
            const testBarcodes = [
                '3017620422003', // Nutella (known to exist)
                '7622210449283', // Toblerone
                '5000169005007', // Heinz Ketchup
                '123456789012'   // Likely non-existent
            ];
            
            for (const barcode of testBarcodes) {
                try {
                    log(`üîç Testing barcode: ${barcode}`, 'loading');
                    
                    const startTime = Date.now();
                    const productData = await productAPI.getProductData(barcode);
                    const duration = Date.now() - startTime;
                    
                    if (productData.error) {
                        log(`‚ö†Ô∏è ${barcode}: ${productData.error} (${duration}ms)`, 'warning');
                    } else {
                        log(`‚úÖ ${barcode}: Found "${productData.name}" by ${productData.brand} (${duration}ms)`, 'success');
                        log(`   Category: ${productData.category}`, 'info');
                        log(`   Source: ${productData.source}`, 'info');
                        
                        if (productData.ingredients) {
                            log(`   Ingredients: ${productData.ingredients.substring(0, 100)}...`, 'info');
                        }
                    }
                    
                } catch (error) {
                    log(`‚ùå ${barcode}: ${error.message}`, 'error');
                }
            }
        }

        async function testGeminiAPI() {
            log('ü§ñ Testing Gemini API...', 'info');
            
            if (!geminiAnalyzer) {
                log('‚ùå Gemini analyzer not initialized', 'error');
                return;
            }
            
            // Test with a simple product
            const testProduct = {
                barcode: '3017620422003',
                name: 'Nutella',
                brand: 'Ferrero',
                category: 'Spreads',
                ingredients: 'Sugar, Palm Oil, Hazelnuts, Cocoa, Milk Powder',
                packaging: 'Glass jar',
                origin: 'Italy',
                nutrition: {
                    energy: 2252,
                    fat: 30.9,
                    carbs: 57.5,
                    protein: 6.3,
                    sugar: 56.3
                }
            };
            
            try {
                log('üîç Testing Gemini API with Nutella data...', 'loading');
                
                const startTime = Date.now();
                const analysis = await geminiAnalyzer.analyzeCarbonFootprint(testProduct);
                const duration = Date.now() - startTime;
                
                log(`‚úÖ Gemini API responded successfully (${duration}ms)`, 'success');
                log(`Carbon footprint per unit: ${analysis.carbonFootprint?.perUnit || 'N/A'} kg CO2`, 'success');
                log(`Water usage per unit: ${analysis.waterUsage?.perUnit || 'N/A'} liters`, 'success');
                log(`Sustainability score: ${analysis.sustainabilityScore || 'N/A'}/100`, 'success');
                log(`Analysis source: ${analysis.metadata?.source || 'Unknown'}`, 'info');
                log(`Analysis confidence: ${analysis.metadata?.confidence || 'Unknown'}`, 'info');
                
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    log(`Recommendations: ${analysis.recommendations.slice(0, 2).join(', ')}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Gemini API test failed: ${error.message}`, 'error');
                
                // Provide specific guidance based on error type
                if (error.message.includes('API key')) {
                    log('üí° Fix: Add your Gemini API key to the .env file', 'warning');
                    log('   1. Go to https://aistudio.google.com/', 'info');
                    log('   2. Create an API key', 'info');
                    log('   3. Add GEMINI_API_KEY=your_key_here to .env', 'info');
                } else if (error.message.includes('401')) {
                    log('üí° Fix: Your Gemini API key is invalid or expired', 'warning');
                } else if (error.message.includes('429')) {
                    log('üí° Fix: Rate limit exceeded, wait a moment and try again', 'warning');
                } else if (error.message.includes('network')) {
                    log('üí° Fix: Check your internet connection', 'warning');
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ CarbonLens API Test Suite Ready', 'success');
            log('Click "Run All Tests" to start comprehensive testing', 'info');
        });
    </script>
</body>
</html>
